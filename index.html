<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Worker Metrics Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .bar-container {
      background-color: #e5e7eb; /* gray-200 */
      border-radius: 4px;
      overflow: hidden;
      height: 16px;
      margin-top: 4px;
    }
    .bar-processed {
      background-color: #10b981; /* green */
      height: 100%;
    }
    .bar-failed {
      background-color: #ef4444; /* red */
      height: 100%;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen p-6">
  <h1 class="text-3xl font-bold mb-6 text-center">Worker Metrics Dashboard</h1>

  <div id="metrics-container" class="grid gap-6 md:grid-cols-2 lg:grid-cols-3"></div>

  <script>
    const METRICS_URL = 'https://worker-5xfi.onrender.com/metrics';

    async function fetchMetrics() {
      try {
        const res = await fetch(METRICS_URL);
        const text = await res.text();
        const lines = text.split('\n').filter(line => line && !line.startsWith('#'));

        const metricsData = {};
        lines.forEach(line => {
          const [key, value] = line.split(' ');
          metricsData[key] = Number(value);
        });

        renderMetrics(metricsData);
      } catch (err) {
        console.error('Failed to fetch metrics:', err);
      }
    }

    function renderMetrics(metricsData) {
      const container = document.getElementById('metrics-container');
      container.innerHTML = '';

      // Group metrics by worker
      const workers = {};
      for (const key in metricsData) {
        const parts = key.split('_');
        const workerName = parts[0];
        const metricType = parts.slice(1).join('_');
        if (!workers[workerName]) workers[workerName] = [];
        workers[workerName].push({ name: metricType, value: metricsData[key] });
      }

      for (const workerName in workers) {
        const card = document.createElement('div');
        card.className = 'bg-white shadow rounded p-4';

        const title = document.createElement('h2');
        title.className = 'text-xl font-semibold mb-3';
        title.textContent = workerName;
        card.appendChild(title);

        const list = document.createElement('div');
        list.className = 'space-y-4';

        workers[workerName].forEach(metric => {
          const metricDiv = document.createElement('div');

          const label = document.createElement('div');
          label.className = 'flex justify-between';
          label.innerHTML = `<span class="font-medium">${metric.name.replace(/_/g, ' ')}</span> <span class="font-mono">${metric.value}</span>`;
          metricDiv.appendChild(label);

          // Render bar for processed/failed events
          if (metric.name.endsWith('processed') || metric.name.endsWith('failed')) {
            const barContainer = document.createElement('div');
            barContainer.className = 'bar-container flex';

            const bar = document.createElement('div');
            bar.style.width = `${Math.min(metric.value * 5, 100)}%`; // simple scaling
            bar.className = metric.name.endsWith('processed') ? 'bar-processed' : 'bar-failed';
            barContainer.appendChild(bar);

            metricDiv.appendChild(barContainer);
          }

          list.appendChild(metricDiv);
        });

        card.appendChild(list);
        container.appendChild(card);
      }
    }

    // Initial fetch
    fetchMetrics();
    // Refresh every 5 seconds
    setInterval(fetchMetrics, 5000);
  </script>
</body>
</html>